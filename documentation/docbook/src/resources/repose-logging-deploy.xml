<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book [
<!-- product name is likely to change; parameterize full name, abbreviated name, expanded name -->
<!ENTITY PRODNAME "Repose">
<!ENTITY PRODABBREV "Repose">
<!ENTITY PRODEXPAND "REstful PrOxy Service Engine">
    <!-- Some useful entities borrowed from HTML -->
    <!ENTITY ndash  "&#x2013;">
    <!ENTITY mdash  "&#x2014;">
    <!ENTITY hellip "&#x2026;">

    <!-- Useful for describing APIs -->
    <!ENTITY GET    '<command xmlns="http://docbook.org/ns/docbook">GET</command>'>
    <!ENTITY PUT    '<command xmlns="http://docbook.org/ns/docbook">PUT</command>'>
    <!ENTITY POST   '<command xmlns="http://docbook.org/ns/docbook">POST</command>'>
    <!ENTITY DELETE '<command xmlns="http://docbook.org/ns/docbook">DELETE</command>'>

    <!ENTITY CHECK  '<inlinemediaobject xmlns="http://docbook.org/ns/docbook">
        <imageobject>
        <imagedata fileref="img/Check_mark_23x20_02.svg"
        format="SVG" scale="60"/>
        </imageobject>
        </inlinemediaobject>'>

    <!ENTITY ARROW  '<inlinemediaobject xmlns="http://docbook.org/ns/docbook">
        <imageobject>
        <imagedata fileref="img/Arrow_east.svg"
        format="SVG" scale="60"/>
        </imageobject>
        </inlinemediaobject>'>
]>
<!-- in BOOK below, add status="draft" to set watermark on cover and left margin -->
<book version="5.0" xmlns="http://docbook.org/ns/docbook"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:svg="http://www.w3.org/2000/svg"
      xmlns:m="http://www.w3.org/1998/Math/MathML"
      xmlns:html="http://www.w3.org/1999/xhtml"
      xmlns:db="http://docbook.org/ns/docbook" 
      xml:id="Repose-Logging-Deployment-Guide">
    <?rax pdf.url="../../repose-logging-deploy.pdf"?>
    <title>&PRODNAME; HTTP Logging Component Deployment
        Handbook</title>
    <!-- set watermark on cover and left margin 
        <?rax status.bar.text="CONFIDENTIAL"?>
    -->
    <?rax title.font.size="35px" subtitle.font.size="16px"?>
    <titleabbrev>&PRODABBREV; HTTP Logging Deployment</titleabbrev>
    <info>
        <author>
            <personname>
                <firstname/>
                <surname/>
            </personname>
            <affiliation>
                <orgname>Rackspace Cloud</orgname>
            </affiliation>
        </author>
        <copyright>
            <year>2010</year>
            <year>2011</year>
            <year>2012</year>
            <holder>Rackspace US, Inc.</holder>
        </copyright>
        <releaseinfo>v1.0</releaseinfo>
        <productname>&PRODNAME;</productname>
        <pubdate>2012-01-30</pubdate>
        <legalnotice role="apache2">
            <annotation>
                <remark>Copyright details are filled in by the template.</remark>
            </annotation>
        </legalnotice>
        <abstract>
            <para>This document is intended for systems administrators interested in configuring
                their service to use the logging component of the &PRODEXPAND;. </para>
        </abstract>
        <revhistory>
            <revision>
                <date>2012-01-30</date>
                <revdescription>
                    <itemizedlist spacing="compact">
                        <listitem><para>Clarified current limitation to HTTP logging.</para></listitem>
                    </itemizedlist>
                </revdescription>
            </revision>
            <revision>
                <date>2012-01-11</date>
                <revdescription>
                    <itemizedlist spacing="compact">
                        <listitem><para>Initial release.</para></listitem>
                    </itemizedlist>
                </revdescription>
            </revision>
        </revhistory>
    </info>
    <chapter xml:id="Overview-d1e85">
        <title>About This Document</title>
            <para> The purpose of this handbook is to facilitate
            deployment of &PRODNAME;'s HTTP logging component. This
            handbook is not a tutorial. It provides basic information
            that will help you understand and deploy this &PRODNAME;
            component, but you must adapt this information to suit
            your own configuration. </para>
            <para>
                This handbook is focused on one &PRODNAME; component.
                Other &PRODNAME; components are documented in companion handbooks.
            </para>
        <section xml:id="Document_Change_History-d1e102">
            <title>Document Change History</title>
            <para>This version of the guide replaces and obsoletes all previous versions.
                The most recent changes are described in the table below: </para>
            <?rax revhistory?>
        </section>
        <xi:include href="chapters/available-doc.xml"/>
    </chapter>
    <!-- naming this section xml:id="Introduction-000" to make it the first page opened in HTML, matching <webhelpDefaultTopic>Introduction-000.html</webhelpDefaultTopic> in pom.xml -->
    <chapter xml:id="Introduction-000">
        <title>Introduction to the HTTP Logging Component of
            &PRODNAME;</title>
        <para>
            &PRODNAME;'s HTTP logging component allows logging of information in HTTP requests that are sent to &PRODNAME; and responses sent from &PRODNAME;.
        </para>
        <para>
            HTTP logging in &PRODNAME; is based on the Apache HTTPD Logging Standard, described at 
            <link xlink:href="http://httpd.apache.org/docs/2.2/mod/mod_log_config.html">http://httpd.apache.org/docs/2.2/mod/mod_log_config.html</link>.
        </para>
        <para> The versioning component enhances the incoming request with an HTTP header named
                <code>X-PP-Service-Origin</code>. This header can be used by components further down
            the stack to perform routing. </para>
        <figure xml:id="Overview">
            <title>Overview of &PRODNAME; HTTP Logging</title>
            <mediaobject>
                <imageobject>
                    <imagedata fileref="figures/repose-logging-HTTPoverview.png" format="PNG" align="center"/>
                </imageobject>
            </mediaobject>
        </figure>
    </chapter>
    <chapter xml:id="Configuration-d1e365">
        <title>Configuration</title>
        <para> 
            To add the HTTP logging component to a &PRODNAME; deployment, 
            add the <code>http-logging</code> filter to the configuration file.
        </para>
        <important>
            <para>
                &PRODNAME;'s HTTP logging component can only be deployed on a system which supports the UTF-8 character set. 
                If the system does not support UTF-8, an error will be thrown at startup and &PRODNAME; will exit. 
            </para>
        </important>
        <para> To configure the &PRODNAME; HTTP logging component,
            edit the <code>http-logging.cfg.xml</code> file. Within
                <code>http-logging.cfg.xml</code>, you can specify
            multiple logs by repeating the <code>http-log</code>
            element; within each <code>http-log</code>, use
                <code>format</code> to specify what to log for each
            request and response; use <code>location</code> to specify
            where the log should be stored.</para>
        <example>
            <title>HTTP Logging Configured for Two Logs</title>
            <programlistingco>
                <areaspec>
                    <area xml:id="logging-config-HTTP.xml.http-logging" units="linecolumn" coords="4 14"/>
                    <area xml:id="logging-config-HTTP.xml.id" units="linecolumn" coords="8 9"/>
                    <area xml:id="logging-config-HTTP.xml.format-detailed" units="linecolumn" coords="9 9"/>
                    <area xml:id="logging-config-HTTP.xml.location" units="linecolumn" coords="12 17"/>
                    <area xml:id="logging-config-HTTP.xml.format-IP" units="linecolumn" coords="18 9"/>
                </areaspec>
            <programlisting language="xml">
<xi:include href="samples/repose-logging-config-HTTP.xml" parse="text"/>
            </programlisting>
            </programlistingco>
        </example>
        <para>
        Key elements of the preceding example are labeled with callouts and explained below: 
        </para>
        <calloutlist>
            <callout arearefs="logging-config-HTTP.xml.http-logging">
                <para>
                    <code>http-logging</code> can have multiple children, 
                    each defined by <code>http-log</code>.
                </para>
                <para> </para>
            </callout>
            <callout arearefs="logging-config-HTTP.xml.id">
                <para>
                    <code>id</code> assigns a label to this log.
                </para>
                <para> </para>
            </callout>
            <callout arearefs="logging-config-HTTP.xml.format-detailed">
                <para>
                    <code>format</code> identifies what to record in this log. 
                    See <xref linkend="Formatting_Log-d1e431"></xref> for help in interpreting <code>format</code>.
                </para>
                 <para> In this example, a tab (<code>\t</code>)
                    separates every item within the record; every
                    record ends by forcing a new line
                    (<code>\n</code>). </para>
                <para> </para>
            </callout>
            <callout arearefs="logging-config-HTTP.xml.location">
                <para>
                    <code>location</code> identifies a file in which to store this log
                </para>
                <para> </para>
            </callout>
            <callout arearefs="logging-config-HTTP.xml.format-IP">
                <para>
                    <code>format</code> identifies what to record in this log. 
                    See <xref linkend="Formatting_Log-d1e431"></xref> for help in interpreting <code>format</code>.
                </para>
                <para>
                    As specified by <code>format</code> in this example, a
                    log record will look like this: 
                    <code>Remote IP=</code><parameter>value</parameter> <code>Local IP=</code><parameter>value</parameter>
                    </para>
                <para> 
                    In this example, no tabs and no new lines are
                    specified, so the log will consist of a single
                    line which contains all the log's records. 
                </para>
                <para> </para>
            </callout>
        </calloutlist>
    </chapter>
    <chapter xml:id="Formatting_Log-d1e431">
        <title>Choosing What to Log</title>
        <para> 
            You can configure &PRODNAME; to log information from a request's URI and headers. 
            You cannot configure &PRODNAME; to log a request's message content.
            This means a log created by &PRODNAME; can be used to investigate operational issues with no risk of exposing sensitive user data.
        </para>
        <para>
            &PRODNAME;'s HTTP logging component implements a subset of the Apache logging functionality described at 
            <link xlink:href="http://httpd.apache.org/docs/2.2/mod/mod_log_config.html">http://httpd.apache.org/docs/2.2/mod/mod_log_config.html</link>.
            The table below lists the request and response information you may choose to log:
        </para>
        <table border="1" frame="box">
            
            <caption>Apache Logging as Implemented by
                &PRODNAME; HTTP Logging Component</caption>
            <col width="25%"/>
            <col width="75%"/>
            <thead>
                <tr>
                    <td>Format String</td>
                    <td>Description</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <code>\t</code>
                    </td>
                    <td>
                        <para> Tab </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>\n</code>
                    </td>
                    <td>
                        <para> Newline </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%%</code>
                    </td>
                    <td>
                        <para> Percent sign </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%a</code>
                    </td>
                    <td>
                        <para> Remote IP address </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%A</code>
                    </td>
                    <td>
                        <para> Local IP address </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%b</code>
                    </td>
                    <td>
                        <para> Size of response in bytes, excluding
                            HTTP headers </para>
                        <para>
                            <emphasis role="italic">In CLF format:
                                uses "-" rather than zero when no
                                bytes are sent.</emphasis>
                        </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%h</code>
                    </td>
                    <td>
                        <para> Remote host </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%m</code>
                    </td>
                    <td>
                        <para> Request method </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%p</code>
                    </td>
                    <td>
                        <para> Canonical port of the server serving
                            the request </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%q</code>
                    </td>
                    <td>
                        <para> Query string </para>
                        <para>
                            <emphasis role="italic">Prepended with "?"
                                if a query string exists; otherwise,
                                an empty string.</emphasis>
                        </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%s</code>
                    </td>
                    <td>
                        <para> Status </para>
                        <para>
                            <emphasis role="italic">For
                                internally-redirected requests, this
                                is the status of the original
                                request.</emphasis>
                        </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%t</code>
                    </td>
                    <td>
                        <para> Time the request was received </para>
                        <para>
                            <emphasis role="italic">Standard English
                                format.</emphasis>
                        </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%u</code>
                    </td>
                    <td>
                        <para> Remote user </para>
                        <para>
                            <emphasis role="italic">May be bogus if
                                status (<code>%s</code>) is
                                401.</emphasis>
                        </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%U</code>
                    </td>
                    <td>
                        <para> URL path requested, excluding any query
                            string </para>
                    </td>
                </tr>
            </tbody>
        </table>                 
 <para>
     For responses with specific HTTP status codes, you can restrict what is logged. 
     The table below shows examples of format strings using this functionality:
 </para>     
        <table border="1" frame="box">
            <caption>Examples of Logging Restricted By HTTP Status
                Code</caption>
            <col width="25%"/>
            <col width="75%"/>
            <thead>
                <tr>
                    <td>Format String</td>
                    <td>Description</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <code>%403,401U</code>
                    </td>
                    <td>
                        <para> For 403 and 401 responses only: log the
                            URL path requested. </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%\!200,304,302U</code>
                    </td>
                    <td>
                        <para> For all responses except 200, 304, and
                            302: log the URL path requested. </para>
                    </td>
                </tr>
            </tbody>
        </table>        
    </chapter>
    <chapter xml:id="Using_Log-d1e531">
        <title>Using the Log</title>
        <para> 
            The log file is a text file, so it can be viewed with
            any text viewer. An example of a text viewer that you can
            use is <emphasis role="bold">Notepad</emphasis>. 
        </para>
        <para>
            You control the location of the log file by specifying its <code>location</code> in the logging configuration.
            See <xref linkend="Configuration-d1e365"></xref> for examples of specifying <code>location</code>.
        </para>
        <para> 
            The log file can be formatted as a tab-delimited file,
            so it can be opened and manipulated as a spreadsheet.
            Examples of spreadsheet software you can use are <emphasis
                role="bold">OpenOffice.org Calc</emphasis> and
                <emphasis role="bold">Microsoft Excel</emphasis>. 
        </para>
        <para> 
            The log file can be huge, so you may wish to examine it
            via an external parser. An example of an external parser
            that you can use is <emphasis role="bold"
            >Flume</emphasis>. 
        </para>
        <para> 
            The log file will grow until it is rotated, moved, or
            deleted. An example of a utility that you can configure to
            rotate and archive the log file is <emphasis role="bold"
                >logrotate</emphasis>. 
        </para>
        <para>
            If you define <code>http-log</code> specifying
            <code>format="Remote IP=%a Local IP=%A Response Size(bytes)=%b Remote Host=%h Request Method=%m Server Port=%p Query String=%q Time Request Received=%t Status=%s Remote User=%u URL Path Requested=%U"/</code>, 
            you will see HTTP responses and log entries as shown in the table below:
        </para>
        <table border="1" frame="box">
            <caption>Requests, Responses, and Log Entries</caption>
            <col width="25%"/>
            <col width="10%"/>
            <col width="66%"/>
            <thead>
                <tr>
                    <td>Request</td>
                    <th>Response</th>
                    <td>Log Entry</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>curl http://50.57.184.12:8887/v1/usertest1 -H
                        "x-auth-token:358484212:99493"</td>
                    <td>200 OK</td>
                    <td>
                        <para> Remote IP=64.39.4.132 Local
                            IP=50.57.184.12 Response Size(bytes)=2048
                            Remote Host=64.39.4.132 Request Method=GET
                            Server Port=8887 Query String=null Time
                            Request Received=13-12-2011-10:17:34.335
                            Status=200 Remote User=usertest1 URL Path
                            Requested=http://valve:8887/resources/mockendservice/v1/usertest1 </para>
                    </td>
                </tr>
                <tr>
                    <td> curl http://50.57.184.12:8887/v1/usertest1 -H
                        "x-auth-token:358484212:99493"</td>
                    <td>413 Request Entity Too Large</td>
                    <td>
                        <para> Remote IP=64.39.4.132 Local
                            IP=50.57.184.12 Response Size(bytes)=2048
                            Remote Host=64.39.4.132 Request Method=GET
                            Server Port=8887 Query String=null Time
                            Request Received=13-12-2011-10:22:17.320
                            Status=413 Remote User=usertest1 URL Path
                            Requested=http://valve:8887/resources/mockendservice/v1/usertest1</para>
                    </td>
                </tr>
            </tbody>
        </table> 
    </chapter>
    <xi:include href="chapters/afterword.xml"/>
</book>
